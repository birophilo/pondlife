<html>

<head>

<script src="js/lib/vue@2.7.16.js"></script>

<style>

body {
  margin: 0;
  padding: 0;
  font-family: Arial, Helvetica, sans-serif;
}

canvas {
  width: 1000px;
  height: 600px;
}

#container {
  display: flex;
  width: 100%;
  justify-content: left;
}

.info-container {
  border: 1px solid black;
  width: 100%;
  padding: 5px;
  height: 1200px;
}

.speed-slide-container {
  display: flex;
  flex-direction: column;
  padding: 5px;
}

.day-container {
  padding: 5px;
}

.menu-subheading {
  font-weight: bold;
  margin: 16px 0 16px 0;
}

.menu-section {
  padding-bottom: 20px;
  border-bottom: 1px solid #ccc;
}

</style>

</head>

<body>

<div id="container">

  <canvas :style="{backgroundColor: 'blue'}"></canvas>

  <div class="info-container">

    <div v-if="selectedAgent !== null">
      {{ selectedAgent.name }} {{ selectedAgent.num }}.
      <br/>
      Money: {{ selectedAgent.stateData.money }}.
      <br/>
      {{ selectedAgent.currentStateName }}
    </div>
    <div></div>

    <div class="menu-section" id="properties-section">
      <h3 class="menu-section-heading">Properties</h3>
      <!-- PROPERTY LIST -->
      <div v-if="selectedAgent !== null" class="item-list">
        <div v-for="property in Object.keys(selectedAgent.stateData)">
          <div v-if="property !== 'globals'">
            <input type="text" placeholder="name" :value="property" disabled />
            <input
              v-model="selectedAgent.stateData[property]"
              type="text"
              :value="selectedAgent.stateData[property]"
            />
            <button @click="delete selectedAgent.stateData[property]">delete</button>
          </div>
          <br/>
        </div>
        <!-- <div v-else>
          <input type="text" placeholder="name" :value="item.name" disabled />:
          <input type="text" placeholder="value" :value="item.value" disabled /> -
          <button @click="item.editing = true">edit</button> |
          <button @click="deleteProperty(item.name)">delete</button>
        </div> -->

        <!-- ADD PROPERTY -->
        <div v-if="propertiesSection.adding.status === false" class="add-container">
          <button @click="propertiesSection.adding.status = true">new property +</button>
        </div>
        <div v-else>
          <input v-model="propertiesSection.adding.newPropertyName" type="text" placeholder="name" />
          <input v-model="propertiesSection.adding.newPropertyValue" type="text" placeholder="value" />
          <button @click="createAgentProperty">add</button> |
          <button @click="cancelSetAgentProperty">cancel</button>
        </div>
      </div>
    </div>

    <!-- ACTIONS -->

    <div class="menu-section" id="actions-section">
      <h3 class="menu-section-heading">Actions</h3>

      <!-- ACTION LIST -->
      <div class="item-list">
        <div v-for="action in actionsSection.items" class="created-item">

          <div class="created-item-header">
            <div class="menu-action-name">{{ action.actionName }}</div>
            <div v-if="action.editing">
              <button @click="action.editing = false">save</button>
              <button @click="action.editing = false">cancel</button>
            </div>
            <div v-else>
              <button @click="action.editing = true">edit</button>
              <button @click="deleteAction(action.actionName)">delete</button>
            </div>
          </div>
          <div>action type: {{ action.actionType }}</div>

          <!-- GOTO ACTION EDIT FORM -->
          <div v-if="action.actionType === 'goTo'">
            <div v-if="action.editing === true">
              <select v-model="action.actionType">
                <option value="goTo">go to</option>
                <option value="change">change</option>
              </select>
              <input v-model="action.args.agentType" type="text" placeholder="target" :value="action.args.agentType" />
            </div>
            <div v-else>
              <input v-model="action.args.agentType" type="text" placeholder="target" :value="action.args.agentType" disabled />
            </div>
          </div>

          <!-- PROPERTY CHANGE ACTION EDIT FORM -->
          <div v-if="action.actionType === 'change'">

            <div v-for="propertyChange in action.propertyChanges">
              <div v-if="action.editing === true">
                <select v-model="propertyChange.propertyName">
                  <option value="money">money</option>
                </select>
                <select v-model="propertyChange.changeType">
                  <option value="increase">increase</option>
                  <option value="decrease">decrease</option>
                </select>
                <input v-model="propertyChange.propertyValue" type="text" placeholder="value" :value="propertyChange.propertyValue" />
              </div>

              <div v-else>
                <input type="text" placeholder="property" :value="propertyChange.propertyName" disabled />
                <input type="text" placeholder="change" :value="propertyChange.changeType" disabled />
                <input type="text" placeholder="value" :value="propertyChange.propertyValue" disabled />    
              </div>

            </div>
          </div>
          <br />

          <h4>Action transitions</h4>

          <div v-for="(transition, index) in action.transitions.items">
            <div v-if="transition.editing === true">
              <select v-for="condition in conditionsSection.items">
                <option :value="transition.condition">{{ conditionReadableFormat(condition) }}</option>
              </select>
              <select v-for="action in actionsSection.items">
                <option :value="transition.nextAction">{{ action.actionName }}</option>
              </select>
              <button @click="transition.editing = false">save</button>
              <button @click="transition.editing = false">cancel</button>
            </div>
            <div v-else>
              IF {{ conditionReadableFormat(transition.condition) }} TRANSITION TO {{ transition.nextAction.name }} 
              <button @click="transition.editing = true">edit</button>
              <button @click="deleteTransition(action, index)">delete</button>
            </div>
          </div>

          <div v-if="action.transitions.adding === true">
            <select v-for="(condition, conditionIndex) in conditionsSection.items" v-model="action.transitions.newCondition">
              <option :value="condition">
                {{ condition.property }} {{ condition.comparison }} {{ condition.value }}
              </option>
            </select>
            <select v-for="action in actionsSection.items" v-model="action.transitions.newNextAction">
              <option :value="action">
                {{ action.actionName }}
              </option>
            </select>
            <button @click="createTransition(action)">add</button> |
            <button @click="cancelAddTransition(action)">cancel</button>
          </div>
          <div v-else>
            <button @click="action.transitions.adding = true">+ Add action transition</button>
          </div>
          
        </div>

        <!-- ACTIONS CREATE -->

        <div v-if="actionsSection.adding.status === false" class="add-container">
          <button @click="actionsSection.adding.status = true">new action +</button>
        </div>
        <div v-else>
          <input v-model="actionsSection.adding.name" type="text" placeholder="name" />
          <br />
          <select v-model="actionsSection.adding.type">
            <option value="goTo">go to</option>
            <option value="change">change</option>
          </select>
          <br />

          <!-- FORM FIELDS SPECIFIC TO ACTION TYPE -->
          <div v-if="actionsSection.adding.type === 'goTo'">
            <input v-model="actionsSection.adding.forms.goTo.target" type="text" placeholder="target" />
          </div>
          <div v-else-if="actionsSection.adding.type === 'change'">
            <select
              v-model="actionsSection.adding.forms.change.property"
              id="action-change-property-name"
            >
              <option value="">-- select property --</option>
              <option value="money">money</option>
            </select>
            <select v-model="actionsSection.adding.forms.change.change" value="change">
              <option value="">-- select change --</option>
              <option value="increase">increase</option>
              <option value="decrease">decrease</option>
            </select>
            <input
              type="text"
              v-model="actionsSection.adding.forms.change.value"
              id="action-change-property-value"
              placeholder="property value"
            />
          </div>
          <button @click="createAction">add</button> |
          <button @click="cancelAddAction">cancel</button>
        </div>
      </div>
    </div>

    <!-- CONDITIONS -->

    <div class="menu-section" id="actions-section">
      <h3 class="menu-section-heading">Conditions</h3>

      <!-- CONDITION LIST -->
      <div class="item-list">
        <div v-for="(item, index) in conditionsSection.items" class="created-item">

          <div class="created-item-header">
            <div class="menu-action-name">{{ item.conditionName }}</div>
            <div class="menu-action-name">{{ item.conditionType === 'property' ? item.property : item.classMethod }}</div>&nbsp;
            <div class="menu-action-name">{{ item.comparison }}</div>&nbsp;
            <div class="menu-action-name">{{ item.conditionValue }}</div>
            <div v-if="item.editing">
              <button @click="item.editing = false">save</button>
              <button @click="item.editing = false">cancel</button>
            </div>
            <div v-else>
              <button @click="item.editing = true">edit</button>
              <button @click="deleteCondition(index)">delete</button>
            </div>
          </div>

          <!-- CONDITION FORM -->
          <div v-if="item.editing === true">
            <select v-model="item.conditionType">
              <option value="property">property</option>
              <option value="preset">preset</option>
            </select>
          </div>
          
            <div v-if="item.editing === true">
              <div v-if="item.conditionType === 'property'">
                <select v-model="item.property">
                  <option value="money">money</option>
                </select>

                <select v-model="item.comparison">
                  <option value="isGreaterThan">is greater than</option>
                  <option value="isLessThan">is less than</option>
                </select>
              </div>
              <div v-else-if="item.conditionType === 'preset'">
                <select v-model="item.classMethod">
                  <option value="atDestination">at destination</option>
                </select>

                <select v-model="item.comparison" value="isIdentical">
                  <option value="isIdentical">is</option>
                </select>
              </div>


              <input v-model="item.conditionValue" type="text" placeholder="value" :value="item.conditionValue" />
            </div>
            <div v-else>
              <div v-if="item.conditionType === 'property'">
                <input type="text" placeholder="property" :value="item.property" disabled />
              </div>
              <div v-else-if="item.conditionType === 'preset'">
                <input type="text" placeholder="preset" :value="item.classMethod" disabled />
              </div>
              <input type="text" placeholder="comparison" :value="item.comparison" disabled />
              <input type="text" placeholder="value" :value="item.conditionValue" disabled />
            </div>
          </div>

          <!-- CONDITION CREATE -->

          <div v-if="conditionsSection.adding.status === false" class="add-container">
            <button @click="conditionsSection.adding.status = true">new condition +</button>
          </div>
          <div v-else>
            <input v-model="conditionsSection.adding.name" type="text" placeholder="name" />
            <br />
            <select v-model="conditionsSection.adding.type">
              <option value="property">property</option>
              <option value="preset">preset</option>
            </select>
            <br />

            <div v-if="conditionsSection.adding.type === 'property'">
              <select
                v-model="conditionsSection.adding.forms.property.property"
                id="action-change-property-name"
              >
                <option value="">-- select property --</option>
                <option value="money">money</option>
              </select>
              <select v-model="conditionsSection.adding.forms.property.comparison" value="isGreaterThan">
                <option value="">-- select comparison --</option>
                <option value="isGreaterThan">is greater than</option>
                <option value="isLessThan">is less than</option>
              </select>
              <input
                type="text"
                v-model="conditionsSection.adding.forms.property.value"
                id="action-change-property-value"
                placeholder="conditions value"
              />
            </div>

            <div v-else-if="conditionsSection.adding.type === 'preset'">
              <select
                v-model="conditionsSection.adding.forms.preset.preset"
                id="action-change-property-name"
              >
                <option value="">-- select preset --</option>
                <option value="atDestination">at destination</option>
              </select>

              <select v-model="conditionsSection.adding.forms.preset.comparison" value="isIdentical">
                <option value="">-- select comparison --</option>
                <option value="isIdentical">is</option>
              </select>
              <input
                type="text"
                v-model="conditionsSection.adding.forms.preset.value"
                id="action-change-property-value"
                placeholder="conditions value"
              />
            </div>

            <button @click="createCondition">add</button> |
            <button @click="cancelAddCondition">cancel</button>

        </div>
      </div>

    </div>

    <div class="menu-section">

      <div class="day-container">
        Day: <span id="day-number"></span>
      </div>

      <div class="speed-slide-container">
        <div><span>Speed: </span><span id="sim-speed-value">1.0</span></div>
        <input type="range" min="0" max="200" value="100" id="sim-speed-slider">
      </div>

    </div>
  </div>
</div>

</body>

<script src="js/constants.js"></script>
<script src="js/globalSettings.js"></script>
<script src="js/Sprite.js"></script>
<script src="js/Timer.js"></script>
<script src="js/Condition.js"></script>
<script src="js/Action.js"></script>
<script src="js/LemonadeStall.js"></script>
<script src="js/SupplyVan.js"></script>
<script src="js/Customer.js"></script>
<script src="js/SelectionMenu.js"></script>

<script>

let canvas;
let c;

const backgroundColor = 'rgb(200, 200, 200)'

const AGENTS = {
  customer: Customer,
  lemonadeStall: LemonadeStall,
  supplyVan: SupplyVan
}

let createdActions = []
let createdConditions = []
let createdPresetConditions = []

let globalSpeed = GlobalSettings.globalSpeed
let dayNumber = 1
const dayLength = 1000 // frames

// const customerData = [{x: 0, y: 0}, {x: 900, y: 400}]
const customerData = [{x: 900, y: 400}]
const lemonadeStallData = [firstStall, secondStall]
// const supplyVanData = [{x: 800, y: 800}]
const supplyVanData = []
const agentMenuButtonData = [
  {name: 'customer', rgb: [255, 0, 0]},
  {name: 'lemonadeStall', rgb: [0, 0, 255]},
  {name: 'supplyVan', rgb: [255, 255, 0]}
]


// function addAgent(agentClassName, agentClass, agentArray) {
//   const num = agentArray.length + 1
//   agentArray.push( new agentClass({
//     position: {
//       x: mouse.x - AGENT_CONFIGS[agentClassName].config.width / 2,
//       y: mouse.y - AGENT_CONFIGS[agentClassName].config.height / 2
//     },
//     num: num,
//     globals: GlobalSettings,
//     offset: AGENT_CONFIGS[agentClassName].config.offset,
//     scale: AGENT_CONFIGS[agentClassName].config.scale,
//     config: AGENT_CONFIGS[agentClassName].config
//   }))
// }


function changeAgentStateFromButton(agent, actionClass, args={}) {
  agent.actionList.push(new actionClass(agent, args))
}

function endDay() {
  dayNumber++
}

function pointIsInArea(point = {x, y}, area = {x, y, width, height}) {
  if (
    point.x >= area.x &&
    point.x <= area.x + area.width &&
    point.y >= area.y &&
    point.y <= area.y + area.height
  ) {
    document.body.style.cursor = 'pointer'
    return true
  } else {
    return false
  }
}


/* --- UPDATE HTML --- */

var slider = document.getElementById('sim-speed-slider')
var sliderValue = document.getElementById('sim-speed-value')

sliderValue.innerHTML = slider.value / 100

slider.oninput = function() {
  GlobalSettings.globalSpeed = this.value
  sliderValue.innerHTML = this.value / 100
}

function createAgent() {
  console.log('creating agent')
  const newAgentName = document.getElementById('form-create-agent-name')
  const newAgentWidth = document.getElementById('form-create-agent-width')
  const newAgentHeight = document.getElementById('form-create-agent-height')
  agentData = AGENT_CONFIGS[newAgentName.value]
  let config = agentData.config
  config.width = Number(newAgentWidth.value)
  config.height = Number(newAgentHeight.value)

  let newIcon = new AgentMenuIcon({
    menu: itemMenu,
    i: agentMenuButtons.length + 1,
    name: newAgentName.value,
    agent: agentData.agentClass,
    config: config
  })
  agentMenuButtons.push(newIcon)
}


// function createTransitionCheck() {

//   const transitionCheckActionId = document.getElementById('form-transition-action').value
//   const transitionCheckConditionId = document.getElementById('form-transition-condition').value
//   const transitionCheckNextActionId = document.getElementById('form-transition-next-action').value

//   console.log(transitionCheckActionId, transitionCheckConditionId, transitionCheckNextActionId)

//   const action = createdActions.filter(action => action.id === Number(transitionCheckActionId))[0]
//   const condition = createdPresetConditions.filter(cond => cond.id === Number(transitionCheckConditionId))[0]
//   const nextAction = createdActions.filter(action => action.id === Number(transitionCheckNextActionId))[0]

//   console.log(action, condition, nextAction)

//   action.transitionChecks.push({
//     condition: condition,
//     nextAction: nextAction
//   })
// }


/* ********************************** */
/* ****** END OF INDEX.JS CODE ****** */
/* ********************************** */

const DEFAULT_ACTION_TYPE = 'goTo'
const DEFAULT_CONDITION_TYPE = 'property'


var vue = new Vue({
  el: '#container',
  data: {

    selectedAgent: null,
    agentPreview: null,
    placingAgent: false,
    deleteMode: false,
    deleteButton: null,
    itemMenu: null,

    mouse: {x: 0, y: 0},

    customers: [],
    lemonadeStalls: [],
    supplyVans: [],
    agentMenuButtons: [],

    propertiesSection: {
      items: [{name: 'money', value: 200, editing: false}],
      adding: {
        status: false,
        newPropertyName: '',
        newPropertyValue: ''
      }
    },
    actionsSection: {
      items: [
        // {
        //   name: 'go to shop',
        //   type: 'goTo',
        //   target: 'lemonadeStall 1',
        //   editing: false,
        //   transitions: {
        //     items: [],
        //     adding: false,
        //     newCondition: '',
        //     newNextAction: ''
        //   }
        // }
      ],
      adding: {
        status: false,
        type: 'goTo',
        name: '',
        forms: {
          goTo: {
            target: ''
          },
          change: {
            property: '',
            change: '',
            value: ''
          }
        }

      }
    },
    conditionsSection: {
      items: [
        // {
        //   type: 'property',
        //   property: 'money',
        //   comparison: 'isGreaterThan',
        //   value: 20,
        //   editing: false
        // }
      ],
      adding: {
        status: false,
        type: 'property',
        forms: {
          property: {
            property: '',
            comparison: '',
            value: ''
          },
          preset: {
            preset: '',
            comparison: '',
            value: ''
          }
        }
      }
    }
  },

  mounted: function () {
    canvas = document.querySelector('canvas')
    c = canvas.getContext('2d')

    canvas.width = 1000
    canvas.height = 600

    c.fillStyle = backgroundColor
    c.fillRect(0, 0, canvas.width, canvas.height)

    this.loadAgentsAndFixtures()

    this.animate()

    /* --- CLICK ACTIONS / EVENT LISTENERS --- */

    canvas.addEventListener('mousemove', (event) => {
      this.mouse.x = event.clientX
      this.mouse.y = event.clientY
    })

    canvas.addEventListener('click', (event) => {
      const point = {x: event.x, y: event.y}

      // PLACE NEW AGENT ON
      if (this.placingAgent) {
        const isInMenuArea = pointIsInArea(point, this.itemMenu.area)
        if (isInMenuArea === false) {
          const agentClassName = this.agentPreview.agent.agentName()
          this.addAgent(
            agentClassName,
            this.AGENT_CONFIGS[agentClassName].agentClass,
            this.AGENT_CONFIGS[agentClassName].agentArray
          )
          this.placingAgent = false
          this.agentPreview = null
        }
      }

      const agentNameList = Object.keys(this.AGENT_CONFIGS)

      agentNameList.forEach(agentName => {
        this.selectOrDeleteAgent(agentName, point)
      })

      // SELECT AGENT BUTTON TO CREATE CURSOR PREVIEW (to place new agent on board)
      for (let i = 0; i < this.agentMenuButtons.length; i++) {

        const isInArea = pointIsInArea(point, this.agentMenuButtons[i].area)

        if (isInArea && !this.agentPreview) {
          agentPreview = new AgentPreview({
            agent: AGENTS[this.agentMenuButtons[i].name],
            rgb: this.agentMenuButtons[i].rgb,
            config: AGENT_CONFIGS[this.agentMenuButtons[i].name].config
          })

          this.placingAgent = true
          break

        } else if (isInArea && agentPreview) {
          // if have active agent preview (tracking cursor), clicking on the agent menu again cancels the selection
          this.placingAgent = false
          this.agentPreview = null
        }
      }

      // TOGGLE DELETE MODE
      const isInArea = pointIsInArea(point, this.deleteButton.area)
      if (isInArea) {
        this.deleteMode = !this.deleteMode
      }

    })

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Escape' && this.placingAgent === true) {
        this.placingAgent = false
        this.agentPreview = null
      }
    })
  },

  methods: {
    loadAgentsAndFixtures: function () {

      lemonadeStallData.forEach(stall => {
        this.lemonadeStalls.push(
          new LemonadeStall(stall)
        )
      })
      supplyVanData.forEach(van => {
        this.supplyVans.push(
          new SupplyVan({
            position: van,
            globals: GlobalSettings,
            offset: this.AGENT_CONFIGS.supplyVan.config.offset,
            scale: this.AGENT_CONFIGS.supplyVan.config.scale
          })
        )
      })
      customerData.forEach((cust, i) => {
        this.customers.push( new Customer({
          position: {x: cust.x, y: cust.y},
          num: i + 1,
          globals: GlobalSettings,
          offset: this.AGENT_CONFIGS.customer.config.offset,
          scale: this.AGENT_CONFIGS.customer.config.scale
        }))
      })
      this.itemMenu = new AgentMenu()
      agentMenuButtonData.forEach((icon, i) => {
        this.agentMenuButtons.push(
          new AgentMenuIcon({
            menu: this.itemMenu,
            i: i,
            name: icon.name,
            agent: this.AGENT_CONFIGS[icon.name].agentClass,
            config: this.AGENT_CONFIGS[icon.name].config
          })
        )
      })
      this.deleteButton = new DeleteButton({
        menu: this.itemMenu,
        i: this.agentMenuButtons.length
      })
    },
    createAgentProperty: function () {
      const propName = this.propertiesSection.adding.newPropertyName
      const propValue = this.propertiesSection.adding.newPropertyValue
      this.selectedAgent.setProperty(propName, propValue)
      this.propertiesSection.adding.newPropertyName = ''
      this.propertiesSection.adding.newPropertyValue = ''
      this.propertiesSection.adding.status = false
    },
    deleteProperty: function (itemName) {
      this.propertiesSection.items = this.propertiesSection.items.filter(item => item.name !== itemName)
    },
    cancelSetAgentProperty: function () {
      this.propertiesSection.adding.status = false
      this.propertiesSection.adding.newPropertyName = ''
      this.propertiesSection.adding.newPropertyValue = ''
    },
    createAction: function () {
      const actionType = this.actionsSection.adding.type
      const data = this.actionsSection.adding.forms[actionType]
      const actionName = this.actionsSection.adding.name

      if (actionType === 'goTo') {

        // const agentChoiceValue = document.agentRadioSelect.agentChoice.value
        // hard-code for now
        const agentChoiceValue = 'nearest'
        const actionDestination = data.target

        let args = {
          id: this.actionsSection.items.length + 1,
          actionName: actionName,
          actionType: actionType,
          agentType: actionDestination,
          agentChoice: agentChoiceValue,

          target: data.target
        }

        if (actionDestination === 'home') {
          args.destination = this.selectedAgent.home
        } else {
          args.agentType = actionDestination
          args.agentChoice = agentChoiceValue
        }

        let newAction = new ActionGoTo(null, args)

        this.actionsSection.items.push(newAction)

      }

      if (actionType === 'change') {

        const propertyName = data.property
        const propertyChangeType = data.change
        const propertyChangeValue = Number(data.value)

        const change1 = new PropertyChange(
          null,
          propertyName,
          propertyChangeType,
          propertyChangeValue
        )

        const propertyChangesAction = new ActionPropertyChanges(
          null,
          {
            id: this.actionsSection.items.length + 1,
            actionName: actionName,
            actionType: actionType,
            propertyChanges: [change1]
          },
          [],
          [],
          [change1]
        )

        this.actionsSection.items.push(propertyChangesAction)

      }

      this.resetActionForms()

    },

    resetActionForms: function () {
      // reset common form data/settings
      this.actionsSection.adding.name = ''
      this.actionsSection.adding.type = DEFAULT_ACTION_TYPE
      this.actionsSection.adding.status = false

      // reset specific settings (hard-coded keys for now)
      this.actionsSection.adding.forms.goTo.target = ''
      this.actionsSection.adding.forms.change.property = ''
      this.actionsSection.adding.forms.change.change = ''
      this.actionsSection.adding.forms.change.value = ''

    },
    deleteAction: function (itemName) {
      this.actionsSection.items = this.actionsSection.items.filter(item => item.actionName !== itemName)
    },
    cancelAddAction: function () {
      this.resetActionForms()
    },
    deleteCondition: function (index) {
      this.conditionsSection.items.splice(index, 1)
    },
    createCondition: function () {
      const conditionType = this.conditionsSection.adding.type
      const data = this.conditionsSection.adding.forms[conditionType]

      if (conditionType === 'property') {

        console.log('creating condition')
        const conditionProperty = data.property
        const conditionComparison = data.comparison
        const conditionValue = data.value

        var newCondition = new Condition(
          this.selectedAgent,
          conditionProperty,
          conditionComparison,
          Number(conditionValue),
          this.conditionsSection.items.length + 1  // id
        )
      } else {

        console.log('creating preset condition')
        const conditionPreset = data.preset
        const conditionComparison = data.comparison
        const conditionValue = data.value

        var newCondition = new PresetCondition(
          this.selectedAgent,
          conditionPreset,
          conditionComparison,
          true,  // hard-coded for now,
          this.conditionsSection.items.length + 1  // id
        )
      }

      this.conditionsSection.items.push(newCondition)
      // hard coding temporarily
      this.actionsSection.items[0].conditions.push(newCondition)
      this.resetConditionForms()

    },
    resetConditionForms: function () {
      // reset common form data/settings
      this.conditionsSection.adding.name = ''
      this.conditionsSection.adding.type = DEFAULT_CONDITION_TYPE
      this.conditionsSection.adding.status = false

      // reset specific settings (hard-coded keys for now)
      this.conditionsSection.adding.forms.property.property = ''
      this.conditionsSection.adding.forms.property.comparison = ''
      this.conditionsSection.adding.forms.property.value = ''
      this.conditionsSection.adding.forms.preset.preset = ''
      this.conditionsSection.adding.forms.preset.comparison = ''
      this.conditionsSection.adding.forms.preset.value = ''
    },
    cancelAddCondition: function () {
      this.resetConditionForms()
    },
    createTransition: function (action) {
      const transitionCondition = action.transitions.newCondition
      const transitionNextAction = action.transitions.newNextAction
      action.transitions.items.push({
        condition: transitionCondition,
        nextAction: transitionNextAction,
        editing: false
      })
      action.transitions.newCondition = ''
      action.transitions.newNextAction = ''
      action.transitions.adding = false
    },
    cancelAddTransition: function (action) {
      action.transitions.adding = false
      action.transitions.newCondition = ''
      action.transitions.newNextAction = ''
    },
    deleteTransition: function (action, transitionIndex) {
      action.transitions.items.splice(transitionIndex, 1)
    },
    conditionReadableFormat: function (condition) {
      const readable = `${ condition.property } ${ condition.comparison } ${ condition.value }`
      console.log(readable)
      return readable
    },

    /* ANIMATE */

    animate: function () {

      let hover = null

      c.fillStyle = backgroundColor
      c.fillRect(0, 0, canvas.width, canvas.height)

      const animationId = requestAnimationFrame(this.animate)
      GlobalSettings.animationFrameId = animationId

      this.lemonadeStalls.forEach(stall => stall.draw())

      this.customers.forEach(customer => {
        customer.update({ globals: GlobalSettings })
        const isInArea = pointIsInArea(this.mouse, customer.collisionArea)
        if (isInArea) {
          hover = true
        }
      })

      this.lemonadeStalls.forEach(stall => {
        const isInArea = pointIsInArea(this.mouse, stall.collisionArea)
        if (isInArea) {
          hover = true
        }
      })

      this.supplyVans.forEach(van => {
        van.update({ globals: GlobalSettings })
        const isInArea = pointIsInArea(this.mouse, van.collisionArea)
        if (isInArea) {
          hover = true
        }
      })
      
      this.itemMenu.update(this.agentMenuButtons.length + 1)

      this.agentMenuButtons.forEach((button, i) => {
        button.update(i)
        const isInArea = pointIsInArea(this.mouse, button.area)
        if (isInArea) {
          hover = true
        }
      })

      if (this.agentPreview) this.agentPreview.update(this.mouse)
      if (pointIsInArea(this.mouse, this.deleteButton.area)) hover = true

      this.deleteButton.update(this.agentMenuButtons.length, this.deleteMode)

      canvas.style.cursor = hover ? 'pointer' : 'auto'

      if (animationId % dayLength === 0) endDay()

      timers.forEach((timer, i) => {
        timer.check(animationId)
        if (timer.active === false) {
          timers.splice(i, 1)
        }
      })

    },

    selectOrDeleteAgent: function (agentClassName, point) {
      let agentArray = this.AGENT_CONFIGS[agentClassName].agentArray
      agentArray.forEach((agent, i) => {
        const isInArea = pointIsInArea(point, agent.collisionArea)

        // SELECT AGENT
        if (isInArea) {
          this.selectedAgent = agent
        }
        // DELETE AGENT (in delete mode)
        if (isInArea && this.deleteMode === true) {
          agentArray.splice(i, 1)
          this.deleteMode = false
        }
      })
    },

    addAgent: function (agentClassName, agentClass, agentArray) {
      const num = agentArray.length + 1
      agentArray.push( new agentClass({
        position: {
          x: this.mouse.x - this.AGENT_CONFIGS[agentClassName].config.width / 2,
          y: this.mouse.y - this.AGENT_CONFIGS[agentClassName].config.height / 2
        },
        num: num,
        globals: GlobalSettings,
        offset: this.AGENT_CONFIGS[agentClassName].config.offset,
        scale: this.AGENT_CONFIGS[agentClassName].config.scale,
        config: this.AGENT_CONFIGS[agentClassName].config
      }))
    },

    createTransitionCheck: function () {

      const transitionCheckActionId = document.getElementById('form-transition-action').value
      const transitionCheckConditionId = document.getElementById('form-transition-condition').value
      const transitionCheckNextActionId = document.getElementById('form-transition-next-action').value

      console.log(transitionCheckActionId, transitionCheckConditionId, transitionCheckNextActionId)

      const action = this.createdActions.filter(action => action.id === Number(transitionCheckActionId))[0]
      const condition = this.createdPresetConditions.filter(cond => cond.id === Number(transitionCheckConditionId))[0]
      const nextAction = this.createdActions.filter(action => action.id === Number(transitionCheckNextActionId))[0]

      console.log(action, condition, nextAction)

      action.transitions.push({
        condition: condition,
        nextAction: nextAction
      })
    }

  },

  computed: {
    AGENT_CONFIGS: function () {
      return {
        customer: {
          agentClass: Customer,
          agentArray: this.customers,
          config: {
            width: 40,
            height: 40,
            offset: {x: 96, y: 46},
            scale: 0.7,
          }
        },
        lemonadeStall: {
          agentClass: LemonadeStall,
          agentArray: this.lemonadeStalls,
          config: {
            width: 130,
            height: 100,
            offset: {x: 0, y: 0},
            scale: 1
          }
        },
        supplyVan: {
          agentClass: SupplyVan,
          agentArray: this.supplyVans,
          config: {
            width: 50,
            height: 50,
            offset: {x: 2, y: 0},
            scale: 2.5
          }
        }
      }
    }
  }
})


</script>

</html>